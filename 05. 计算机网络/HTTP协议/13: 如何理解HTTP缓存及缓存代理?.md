# 013：如何理解HTTP缓存及缓存代理

关于 `强缓存` 和 `协商缓存`，小结如下：

先通过 `Cache-Control` 验证强缓存是否可用

- 如果强缓存可用，直接使用
- 否则进入协商缓存，即发送http请求，服务器通过请求头中的 `If-Modified-Since` 或者 `If-None-Match` 这些**条件请求**字段检查资源是否更新
  - 若资源更新，返回资源和200状态码
  - 否则，返回304，告诉浏览器直接从缓存中获取资源

这一节我们主要说说另外一种缓存方式：`代理缓存`

## 为什么产生代理缓存

对于源服务器来说，他也是有缓存的，不如Redis、Memcache，但对于HTTP缓存来说，如果每次客户端缓存失效都要到源服务器获取，那给源服务器的压力会很大。

由于引入了**代理缓存**的机制，让 `代理服务器` 接管一部分服务端HTTP缓存，客户端缓存过期后就到代理缓存中获取，代理缓存过期了才请求源服务器，这样流量巨大的时候就明显降低源服务器的压力。

那缓存代理究竟是如何实现的呢？

总的来说，代理缓存的控制分为两部分，一部分是**源服务器**端的控制，一部分是**客户端**的控制。

## 源服务器的缓存控制

### private和public

在源服务器的响应头中，会加上 `Cache-Control` 这个字段进行缓存控制字段，那么它的值中可以加入 `private` 或者 `public` 表示是否允许代理服务器缓存，前者为禁止，后者为允许。

比如对于一些非常私密的数据，如果缓存到代理服务器，别人直接访问代理就可以拿到这些数据，是非常危险的，因为对于这些数据一般是不允许代理服务器进行缓存的，将响应头的 `Cache-Control` 设为 `private` 而不是 `public`。

### proxy-revalidate

`must-revalidate` 的意思是**客户端**缓存过期就去源服务器获取，而 `proxy-revalidate` 则表示**代理服务器**的缓存过期后到代理服务器获取资源。

### s-maxage

`s` 是 `share` 的意思，限定了缓存在代理服务器中可以存放多久，和限制客户端缓存时间的 `max-age` 并不冲突。

举个例子：

```js
Cache-Control: public, max-age=100, s-maxage=2000
```

相当于源服务器说：我这个响应式允许代理服务器缓存的，客户端缓存过期了可以到代理中拿，并且在客户端的缓存时间为1000s，在代理服务器的缓存时间时2000s。

## 客户端的缓存控制

### `max-stale` 和 `min-fresh`

在客户端的请求头中，可以加入这个字段，来对代理服务器上的缓存进行**带宽**和**限制**操作。比如：

```js
max-stale: 5
```

表示客户端到代理服务器上拿缓存的时候，即使代理缓存过期了也不要紧，只要过期时间在5s之内，还是可以从代理中过去。

又比如：

```js
min-fresh: 5
```

表示代理缓存需要一定的新鲜度，不要等到缓存刚好到期再拿，一定要在缓存到期的5s之前拿，否则拿不到。

### only-if-cached

这个字段加上后客户端只会接受代理缓存，而不会接受源服务器的响应。如果代理缓存无效，则直接返回`504(Gateway Timeout)`。

以上便是缓存代理的内容。涉及的字段比较多，一定好好回顾，加深理解。
